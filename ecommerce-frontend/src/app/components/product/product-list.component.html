<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Gestion des Produits</h2>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" (click)="resetForm()">
    <i class="bi bi-plus-lg"></i> Ajouter un Produit
  </button>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="bg-light">
          <tr>
            <th>Photo</th>
            <th>Réf</th>
            <th>Description</th>
            <th>Catégorie</th>
            <th>Prix</th>
            <th>Quantité</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of products()">
            <td>
              <img [src]="product.gallery?.url_photo | safeImage"
                   [alt]="product.ref"
                   class="rounded"
                   style="width: 40px; height: 40px; object-fit: cover;"
                   onerror="this.src='https://placehold.co/40x40?text=Err'">
            </td>
            <td><strong>{{ product.ref }}</strong></td>
            <td>{{ product.description }}</td>
            <td>
              <span class="badge bg-light text-dark border" *ngIf="product.subCategory">
                {{ product.subCategory.category?.name }} > {{ product.subCategory.name }}
              </span>
            </td>
            <td>{{ product.price | currency:'XOF':'symbol':'1.0-0' }}</td>
            <td>
              <span [class.text-danger]="product.qte < 10">{{ product.qte }}</span>
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#productModal" (click)="editProduct(product)">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteProduct(product.id)">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ isEditMode ? 'Modifier' : 'Ajouter' }} un Produit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form (ngSubmit)="saveProduct()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Référence</label>
              <input type="text" class="form-control" [(ngModel)]="selectedProduct.ref" name="ref" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Sous-Catégorie</label>
              <select class="form-select" [(ngModel)]="selectedProduct.subCategory" name="subCategory" [compareWith]="compareSubCategories" required>
                <option [ngValue]="undefined" disabled>Sélectionner...</option>
                <option *ngFor="let sub of subCategories()" [ngValue]="sub">
                  {{ sub.category?.name }} - {{ sub.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" [(ngModel)]="selectedProduct.description" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3" *ngIf="selectedProduct.gallery">
            <label class="form-label">Photo du Produit</label>


            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-upload"></i></span>
              <input type="file" class="form-control" (change)="onFileSelected($event)" accept="image/*">
            </div>

            <div class="text-center my-2 text-muted small">— OU —</div>


            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
              <input type="text" class="form-control" [(ngModel)]="selectedProduct.gallery.url_photo" name="url_photo" placeholder="Coller l'URL de l'image ici (ex: https://...)">
            </div>


            <div class="mt-2 text-center" *ngIf="selectedProduct.gallery.url_photo">
              <img [src]="selectedProduct.gallery.url_photo | safeImage" class="img-thumbnail" style="max-height: 150px;"
                   onerror="this.src='https://placehold.co/150x150?text=Image+non+valide'">
              <div class="small text-muted mt-1">Aperçu de l'image</div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prix (FCFA)</label>
              <input type="number" class="form-control" [(ngModel)]="selectedProduct.price" name="price" step="1" min="0" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Quantité</label>
              <input type="number" class="form-control" [(ngModel)]="selectedProduct.qte" name="qte" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
